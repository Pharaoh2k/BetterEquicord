name: Sync fork (merge-upstream)

on:
  schedule:
    - cron: "0 0 * * *"   # daily 00:00 UTC
  workflow_dispatch:       # allow manual runs

permissions:
  contents: write          # needed for the API to write the merge commit

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Sync fork from upstream (server-side merge)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: main         # change if your default branch is not main
        run: |
          set -euo pipefail
          API="https://api.github.com/repos/${GITHUB_REPOSITORY}/merge-upstream"
          PAYLOAD='{"branch":"'"$BRANCH"'"}'

          # Call the GitHub API: identical to the "Sync fork" button
          STATUS=$(curl -sS -o resp.json -w "%{http_code}" \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -X POST "$API" -d "$PAYLOAD")

          echo "HTTP $STATUS"
          cat resp.json || true

          # Treat "merge conflict" as a non-failing run (you can resolve later)
          if [ "$STATUS" = "200" ]; then
            echo "Upstream merged into $BRANCH."
          elif [ "$STATUS" = "409" ]; then
            echo "Merge conflict from upstream. Leaving branch unchanged."
            exit 0
          else
            echo "merge-upstream API returned HTTP $STATUS"
            exit 1
          fi
